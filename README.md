# LineFollower
COSI119 PA
The code initialize a ROS node which allows the robot follows a distinct line on the ground. The line following is achieved by subscribing to /camera/rgb/image_raw topic through image_sub to distinguish the line, and publishing Twist() to cmd_vel topic through publisher cmd_vel_pub. 

How Line Following Work <br \>
	For Image messages received by image_sub, the callback function for the subscriber image_callback will process the received message, update states of the robot, and publish desired Twist() to cmd_vel according to states of the robot. It first starts with converting the Image message to OpenCV image format and show it on screen using imshow() so that we can see from the robot’s perspective. Then the image is mapped from RGB to HSV space, which separates the image into color, color intensity, and brightness, so that we can create a binary image and easily filter out all colors other than yellow. If yellow is seen by the robot, we change the state of the robot to follow and the robot is expected to follow the yellow line. To follow the line, we calculate the centroid of 20-row portion of image (one meter in front of robot), and denote it with a red circle. And P-controller is implemented to calculate the desired angular velocity of the robot according to the distance between center of the image and centroid of the line so that the robot can move in a way that makes the centroid closer and closer to the center of the camera. The Twist is published to cmd_vel_pub so that robot can correctly follows the line. 

Other Functions
- Start with No Line
	The code also makes the robot able to find the line and follow it when robot starts somewhere the line is not immediately visible. The state of the robot is initialized to find. If robot can not see a line after changing raw image to binary image, its state will not be change to follow so it needs to find the line. In this case, we publish a Twist with linear.x 0.2 and angular.z -0.2, so the robot will move in circular motion until it find a line to follow. When a line is found, the state of the robot will be changed to follow as stated in previous section and follow the line correctly.  
- Double Back
	If the robot follows a line to the end, it will turn 180 degrees to follow the same line back. To differentiate this case from not finding a line to follow, the state of the robot is checked when it’s not seeing a line. If the robot follows a line to the end, its previous state should be follow instead of find. In this case, a Twist with no linear velocity and 0.2 angular velocity is published to cmd_vel_pub so that the robot will turn in place and follows the line back.   
- Obstacle Detection
	The algorithm also supports obstacle detection and avoidance. This is achieved by scan_sub: subscriber that subscribe to the scan topic. The callback function scan_cb will process the scan data and call on change_state function to update states needed for wall following. Each element of the ranges of the laserScan message is processed to be the average of itself and four nearby elements to avoid noise. The processed ranges is separated into seven regions: front, front left, left, back left, back right, right, and front right. The minimum element in each region is selected to compose a region dictionary. In change_state, 0.5 is chosen as threshold. o_state, o_substate, and obstacle is updated according to different data in region dictionary. If obstacle is true, an obstacle is detected and the robot should start wall following process until it sees yellow line again, which will change o_state back to find.     


